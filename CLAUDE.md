# CLAUDE.md - AI開発アシスタントへの重要指示事項

このファイルはAI開発アシスタント（Claude）がMarkMailプロジェクトで作業する際の重要な指示事項をまとめたものです。

## ⚡ 最重要事項

### 絶対に行ってはいけないこと

1. **既存のマイグレーションファイルの削除・変更**

   - データベースマイグレーションファイル（`backend/migrations/*.sql`）は絶対に削除・変更しない
   - 新しいマイグレーションが必要な場合は、新しいタイムスタンプで追加ファイルを作成する
   - 既に適用されたマイグレーションは変更不可能

2. **テストの無効化**

   - テストが失敗する場合は、テストを削除・無効化せず、コードを修正する
   - `#[ignore]`や`skip`の使用は禁止
   - **テストを通すためにロジックを変更する愚行は絶対に禁止**
   - テストは既存のロジックを検証するものであり、テストに合わせてロジックを変更してはならない

3. **直接的なデータベース操作**

   - `DROP TABLE`、`DROP DATABASE`などの破壊的操作は絶対に実行しない
   - データベーススキーマの変更は必ずマイグレーションファイル経由で行う

4. **環境変数・シークレットの露出**
   - `.env`ファイルの内容をコミット・表示しない
   - APIキーやパスワードをハードコーディングしない

## 📋 開発ポリシー（DEVELOPMENT.mdより）

### 基本開発ポリシー

1. **品質重視**: すべてのコードは高品質でテスト可能であること
2. **規約順守**: コーディング規約と自動整形ルールを厳守すること
3. **テスト駆動**: 新機能開発時はテストを先に書くことを推奨
4. **コミットメッセージ**:
   [Conventional Commits](https://www.conventionalcommits.org/)形式に従うこと
5. **テスト**: すべてのPRはテスト合格が必須条件

### ブランチ戦略

- `feature/xxxx` - 新機能開発
- `fix/xxxx` - バグ修正
- `refactor/xxxx` - リファクタリング
- `docs/xxxx` - ドキュメント関連
- `test/xxxx` - テスト関連

## 🛠️ 開発時の必須確認事項

### コード変更前

1. 現在のブランチを確認（`git status`）
2. 最新の変更を取得（`git pull`）
3. 関連するテストを確認

### コード変更後

1. Rustコード: `cargo fmt`と`cargo clippy`を実行
2. TypeScript/JavaScript: `npm run lint`と`npm run format`を実行
3. テストを実行:
   - Backend: `cargo test`
   - Frontend: `npm test`
4. コミット前にlefthookが自動チェックを実行

### データベース変更時

1. 新しいマイグレーションファイルを作成（タイムスタンプ付き）
2. マイグレーションを実行: `sqlx migrate run`
3. `sqlx-data.json`を更新: `cargo sqlx prepare`

## 💻 コーディング規約

### Rust

- 関数は小文字のスネークケース（`do_something`）
- 構造体・列挙型はキャメルケース（`MyStruct`）
- `unwrap()`や`expect()`は極力避け、適切にエラーハンドリングを行う
- `#[derive(Debug)]`を積極的に活用

### TypeScript/JavaScript

- TypeScriptの型を常に使用
- `any`型を極力避ける
- 関数や変数はキャメルケース（`doSomething`）
- コンポーネントや型はパスカルケース（`MyComponent`）
- 非同期処理は`async/await`を使用

### Svelte

- コンポーネントはシングルファイルコンポーネントとして実装
- 親コンポーネントからのプロパティは`export let`で明示的に定義
- スタイルはscoped CSSを使用

## 🧪 テスト要件

### テスト必須要素

1. **新しいAPI**: すべての新しいAPIエンドポイント
2. **認証機能**: 認証関連のすべての機能
3. **ビジネスロジック**: すべての重要なビジネスロジック
4. **バグ修正**: 修正したバグの再発防止テスト

### テスト実行コマンド

```bash
# Backend
cd backend
cargo test

# Frontend
cd frontend
npm test

# E2Eテスト
npm run test:e2e
```

## 📝 コミットメッセージ規約

```
<type>: <subject>

<body>
```

タイプ:

- `feat`: 新機能
- `fix`: バグ修正
- `docs`: ドキュメントのみの変更
- `style`: コードの意味に影響しない変更
- `refactor`: リファクタリング
- `test`: テストの追加・修正
- `chore`: ビルドプロセスやツールの変更

## 🔒 セキュリティ要件

1. すべてのAPIエンドポイントで適切な認証・認可を実施
2. すべてのユーザー入力を適切に検証
3. SQLインジェクション対策: クエリパラメータの使用を徹底
4. XSS対策: ユーザー入力の適切なエスケープ処理
5. 機密情報をログに出力しない

## 🚨 トラブルシューティング

### データベース接続エラー

```bash
# PostgreSQLが起動しているか確認
docker-compose ps

# 起動していない場合
docker-compose up -d postgres

# マイグレーションの実行
cd backend
sqlx migrate run
```

### ビルドエラー

```bash
# Rust
cargo clean
cargo build

# Frontend
cd frontend
rm -rf node_modules
npm install
```

## 📁 プロジェクト構造

```
markmail/
├── backend/           # Rustバックエンド
│   ├── migrations/    # データベースマイグレーション（変更不可）
│   ├── src/
│   │   ├── api/      # APIエンドポイント
│   │   ├── database/ # データベース操作
│   │   ├── models/   # データモデル
│   │   └── services/ # ビジネスロジック
├── frontend/          # Svelteフロントエンド
│   ├── src/
│   │   ├── lib/      # 共通ライブラリ
│   │   └── routes/   # ページコンポーネント
├── infrastructure/    # AWS CDK
└── docker-compose.yml
```

## ⚠️ 警告

- **マイグレーションファイルは絶対に削除・変更しない**
- **テストを無効化しない**
- **本番環境のデータベースには直接アクセスしない**
- **シークレット情報を露出させない**

## 🚫 よくある愚行と防止策

1. **テストを通すためにロジックを変更する**

   - ❌ 悪い例: テストが失敗したので、テストに合わせてビジネスロジックを変更
   - ✅ 良い例: ロジックが正しい場合はテストを修正、バグがある場合はロジックを修正

2. **マイグレーションファイルの削除・変更**

   - ❌ 悪い例: エラーが出たので既存のマイグレーションファイルを削除
   - ✅ 良い例: 新しいタイムスタンプで修正用のマイグレーションを追加

3. **エラーを握りつぶす**
   - ❌ 悪い例: `unwrap()`でエラーが出たので`.unwrap_or_default()`に変更
   - ✅ 良い例: エラーの原因を調査し、適切なエラーハンドリングを実装

このファイルの指示に従い、安全で高品質なコード開発を行ってください。
